# HmPerplexityWeb プロジェクトの問題点

このドキュメントは、`HmPerplexityWeb` プロジェクトのコードベースを分析して見つかった潜在的な問題点や改善点をまとめたものです。

## 1. UIオートメーションへの依存による脆弱性

現在の実装は、`keybd_event` を使用してキーボード入力をシミュレートし、Webブラウザを操作しています。この方法は本質的に脆弱です。

-   **Webサイトの変更に弱い:** PerplexityのWebサイトのUIデザイン（入力フィールドのID、ボタンの位置、キーボードショートカットなど）が変更されると、このツールは即座に動作しなくなります。
-   **実行環境への依存:** ユーザーのPC環境（他の常駐ソフト、OSのバージョン、アクティブウィンドウの状態など）によって、キー入力のシミュレーションが失敗する可能性があります。

## 2. 非同期処理の不適切な使用

`SendCtrlV` や `SendReturn` などのメソッドは `async void` として定義されていますが、`...Sync` という名前のラッパーメソッドから `await` なしで呼び出されています。

-   **競合状態 (Race Condition) の発生:** `...Sync` メソッドはキー入力の完了を待たずに即座にリターンします。これにより、呼び出し元の秀丸マクロが、キー入力が完了する前に次の処理に進んでしまい、予期せぬ動作を引き起こす可能性があります。
-   **タイミングの問題:** `Task.Delay` による待機は、処理の成功を保証するものではなく、環境によっては待機時間が不足したり、逆に不必要に長くなったりする可能性があります。

## 3. 不完全なクリップボード処理

`CaptureForBrowserPane` メソッドは、現在のクリップボードの内容を内部に保存（`CaptureClipboard`）しますが、それを復元する処理（`RestoreClipboard`）を呼び出していません。

-   **クリップボード内容の消失:** 呼び出し元のマクロが `RestoreClipboard` の呼び出しに失敗した場合、ユーザーが元々クリップボードにコピーしていたデータは失われます。これはツールの堅牢性を著しく下げています。

## 4. 初歩的なエラーハンドリング

エラーハンドリングの設計に改善の余地があります。

-   **原因不明のエラー:** `Clipboard.SetText` が失敗した際に、単純に300ms待機して再試行するだけでは、根本的な原因（他のプロセスによるクリップボードのロックなど）の解決にはなりません。
-   **例外の無視:** `CaptureClipboard` 内の空の `catch` ブロックは、例外が発生したことを隠蔽してしまい、問題のデバッグを困難にします。

## 5. 管理されていない外部依存関係

このプロジェクトは `ClipboardHistMngr.exe` や `HmFocusEachBrowserInputField.exe` といった外部の実行ファイルに依存しています。

-   **ビルドとメンテナンスの複雑化:** これらのツールのソースコードは別のリポジトリで管理されており、バージョンも指定されていません。これにより、プロジェクト全体のビルド、テスト、依存関係の管理が非常に困難になっています。

## 6. ドキュメントとコメントの不足

コード内には、なぜ特定の実装がされているのかを説明するコメントがほとんどありません。

-   **保守性の低下:** 例えば、`SendCtrlJKey` がどのような目的で `Ctrl+J` を送信しているのか、各メソッドを呼び出す前にWebブラウザがどのような状態であるべきか、といった前提条件が不明です。これにより、将来の改修やデバッグが困難になります。

## 7. 不適切なコード分割

比較的小さなクラスであるにもかかわらず、`partial class` を使って機能が複数のファイルに分割されています。

-   **可読性の低下:** `HmPerplexityWeb.cs`, `ClipBoard.cs`, `Additional.cs` に分割されていますが、これは過剰な分割であり、かえってコード全体の流れを理解しにくくしています。
